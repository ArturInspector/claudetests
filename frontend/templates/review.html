<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ - Deep Learning Platform</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">Deep Learning Platform</a>
            <nav class="nav">
                <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="/practice">–í–æ–ø—Ä–æ—Å—ã</a>
                <a href="/tasks">–ó–∞–¥–∞—á–∏</a>
                <a href="/review" class="active">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</a>
                <a href="/stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            </nav>
        </div>
    </header>

    <main class="container-narrow">
        <!-- Review Dashboard -->
        <div id="reviewDashboard">
            <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">üîÑ Spaced Repetition</h1>
            <p class="text-secondary" style="font-size: 1.125rem; margin-bottom: 2rem;">
                –ü–æ–≤—Ç–æ—Ä—è–π –º–∞—Ç–µ—Ä–∏–∞–ª –≤ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
            </p>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="grid grid-2 mb-4">
                <div class="stat-card">
                    <div class="stat-value" id="dueTodayCount">0</div>
                    <div class="stat-label">–ù–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="dueTomorrowCount">0</div>
                    <div class="stat-label">–ù–∞ –∑–∞–≤—Ç—Ä–∞</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="totalInReviewCount">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="reviewedTodayCount">0</div>
                    <div class="stat-label">–ü–æ–≤—Ç–æ—Ä–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—á–∞–ª–∞ -->
            <div class="text-center mb-4">
                <button id="startReviewBtn" class="btn btn-primary" style="padding: 1rem 3rem; font-size: 1.125rem;">
                    –ù–∞—á–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
                </button>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ -->
            <div class="card">
                <h3 class="card-title mb-2">–í–æ–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ:</h3>
                <div id="reviewQueueList"></div>
            </div>
        </div>

        <!-- Review Area -->
        <div id="reviewArea" class="hidden">
            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
            <div class="mb-4">
                <div class="flex-between mb-2">
                    <h2>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</h2>
                    <button id="backToDashboardBtn" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</button>
                </div>
                <div class="progress-bar">
                    <div id="reviewProgress" class="progress-fill" style="width: 0%"></div>
                </div>
                <p class="text-secondary" style="font-size: 0.875rem; margin-top: 0.5rem;">
                    <span id="reviewCurrent">0</span> / <span id="reviewTotal">0</span>
                </p>
            </div>

            <!-- –í–æ–ø—Ä–æ—Å -->
            <div id="questionContainer" class="question-container">
                <div class="question-header">
                    <div>
                        <h3 id="questionTitle" style="margin-bottom: 0.5rem;"></h3>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <span id="levelBadge" class="badge badge-level"></span>
                            <span id="difficultyBadge" class="difficulty-badge"></span>
                            <span id="topicBadge" class="badge badge-tag"></span>
                        </div>
                    </div>
                    <div id="questionTimer" style="font-size: 1.5rem; font-weight: 600; color: var(--accent-color);">00:00</div>
                </div>
                
                <div id="questionText" style="line-height: 1.8; margin-top: 1.5rem;"></div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="flex gap-2 mb-4">
                <button id="showAnswerBtnReview" class="btn btn-primary">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
                <button id="skipBtn" class="btn btn-outline">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            </div>

            <!-- –û—Ç–≤–µ—Ç -->
            <div id="answerSection" class="answer-section hidden">
                <div class="answer-header">‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</div>
                <div id="answerText"></div>
                
                <!-- Confidence Rating -->
                <div class="mt-4" style="padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <label style="display: block; margin-bottom: 0.75rem; font-weight: 600;">
                        –ö–∞–∫ —Ö–æ—Ä–æ—à–æ –ø–æ–º–Ω–∏—à—å –º–∞—Ç–µ—Ä–∏–∞–ª?
                    </label>
                    <div class="confidence-grid">
                        <button class="confidence-card" data-level="1">
                            <div class="confidence-emoji">üò∞</div>
                            <div class="confidence-label">–ù–µ –ø–æ–º–Ω—é</div>
                            <div class="confidence-interval">1 –¥–µ–Ω—å</div>
                        </button>
                        <button class="confidence-card" data-level="2">
                            <div class="confidence-emoji">üòï</div>
                            <div class="confidence-label">–ü–ª–æ—Ö–æ</div>
                            <div class="confidence-interval">2 –¥–Ω—è</div>
                        </button>
                        <button class="confidence-card" data-level="3">
                            <div class="confidence-emoji">üôÇ</div>
                            <div class="confidence-label">–ù–æ—Ä–º–∞–ª—å–Ω–æ</div>
                            <div class="confidence-interval">3 –¥–Ω—è</div>
                        </button>
                        <button class="confidence-card" data-level="4">
                            <div class="confidence-emoji">üòä</div>
                            <div class="confidence-label">–•–æ—Ä–æ—à–æ</div>
                            <div class="confidence-interval">7 –¥–Ω–µ–π</div>
                        </button>
                        <button class="confidence-card" data-level="5">
                            <div class="confidence-emoji">ü§©</div>
                            <div class="confidence-label">–û—Ç–ª–∏—á–Ω–æ</div>
                            <div class="confidence-interval">14 –¥–Ω–µ–π</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ó–∞–º–µ—Ç–∫–∏ -->
            <div class="card mt-4" id="notesCard">
                <h3 style="margin-bottom: 0.75rem;">üìù –¢–≤–æ–∏ –∑–∞–º–µ—Ç–∫–∏</h3>
                <div id="userNotesDisplay" class="text-secondary"></div>
            </div>
        </div>

        <!-- Completion -->
        <div id="completionSection" class="hidden">
            <div style="text-align: center;">
                <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">üéâ –í—Å–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã!</h1>
                <p class="text-secondary" style="font-size: 1.125rem; margin-bottom: 2rem;">
                    –¢—ã –ø–æ–≤—Ç–æ—Ä–∏–ª <span id="completedCount" style="font-weight: 600; color: var(--accent-color);">0</span> –≤–æ–ø—Ä–æ—Å–æ–≤
                </p>
                
                <div class="flex gap-2" style="justify-content: center;">
                    <a href="/review" class="btn btn-primary">‚Üê –ù–∞–∑–∞–¥ –∫ –¥–∞—à–±–æ—Ä–¥—É</a>
                    <a href="/practice" class="btn btn-secondary">–ü—Ä–∞–∫—Ç–∏–∫–∞</a>
                </div>
            </div>
        </div>
    </main>

    <script src="/static/app.js"></script>
    <script>
        let reviewQueue = [];
        let currentIndex = 0;
        let currentQuestion = null;
        let questionStartTime = null;
        let questionTimerInterval = null;
        let reviewedToday = 0;

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const reviewDashboard = document.getElementById('reviewDashboard');
        const reviewArea = document.getElementById('reviewArea');
        const completionSection = document.getElementById('completionSection');
        const answerSection = document.getElementById('answerSection');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            await loadReviewStats();
            await loadReviewQueue();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadReviewStats() {
            try {
                const response = await fetch('/api/review/stats');
                const stats = await response.json();
                
                document.getElementById('dueTodayCount').textContent = stats.due_today;
                document.getElementById('dueTomorrowCount').textContent = stats.due_tomorrow;
                document.getElementById('totalInReviewCount').textContent = stats.total_in_review;
                document.getElementById('reviewedTodayCount').textContent = reviewedToday;
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—á–µ—Ä–µ–¥–∏
        async function loadReviewQueue() {
            try {
                const response = await fetch('/api/review/queue?limit=50');
                reviewQueue = await response.json();
                
                const queueList = document.getElementById('reviewQueueList');
                
                if (reviewQueue.length === 0) {
                    queueList.innerHTML = '<p class="text-secondary text-center" style="padding: 2rem;">–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ! üéâ</p>';
                    document.getElementById('startReviewBtn').disabled = true;
                    return;
                }
                
                queueList.innerHTML = reviewQueue.map((q, idx) => `
                    <div style="padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 500;">${q.title}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                ${q.topic_name} ‚Ä¢ Level ${q.level} ‚Ä¢ ${q.difficulty}
                            </div>
                        </div>
                        <span class="badge badge-level badge-level-${q.level}">L${q.level}</span>
                    </div>
                `).join('');
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—á–µ—Ä–µ–¥–∏', 'error');
            }
        }

        // –ù–∞—á–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
        document.getElementById('startReviewBtn').addEventListener('click', () => {
            if (reviewQueue.length === 0) return;
            
            reviewDashboard.classList.add('hidden');
            reviewArea.classList.remove('hidden');
            
            currentIndex = 0;
            loadCurrentQuestion();
        });

        // –ù–∞–∑–∞–¥ –∫ –¥–∞—à–±–æ—Ä–¥—É
        document.getElementById('backToDashboardBtn').addEventListener('click', () => {
            if (confirm('–ü—Ä–µ—Ä–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ?')) {
                window.location.reload();
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
        async function loadCurrentQuestion() {
            if (currentIndex >= reviewQueue.length) {
                showCompletion();
                return;
            }
            
            const questionData = reviewQueue[currentIndex];
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–π –≤–æ–ø—Ä–æ—Å
                const response = await fetch(`/api/question/${questionData.id}/answer`);
                currentQuestion = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('questionTitle').textContent = currentQuestion.title;
                document.getElementById('levelBadge').textContent = `Level ${currentQuestion.level || 1}`;
                document.getElementById('levelBadge').className = `badge badge-level badge-level-${currentQuestion.level || 1}`;
                document.getElementById('difficultyBadge').textContent = currentQuestion.difficulty;
                document.getElementById('difficultyBadge').className = `difficulty-badge ${Utils.getDifficultyClass(currentQuestion.difficulty)}`;
                document.getElementById('topicBadge').textContent = currentQuestion.topic_name;
                
                document.getElementById('questionText').innerHTML = parseMarkdownToHtml(currentQuestion.question_text);
                document.getElementById('questionText').querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                // –ü—Ä–æ–≥—Ä–µ—Å—Å
                const progress = ((currentIndex + 1) / reviewQueue.length) * 100;
                document.getElementById('reviewProgress').style.width = progress + '%';
                document.getElementById('reviewCurrent').textContent = currentIndex + 1;
                document.getElementById('reviewTotal').textContent = reviewQueue.length;
                
                // –ó–∞–º–µ—Ç–∫–∏
                await loadNotes(currentQuestion.id);
                
                answerSection.classList.add('hidden');
                startQuestionTimer();
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–∞', 'error');
            }
        }

        // –¢–∞–π–º–µ—Ä
        function startQuestionTimer() {
            questionStartTime = Date.now();
            questionTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - questionStartTime) / 1000);
                document.getElementById('questionTimer').textContent = formatTime(elapsed);
            }, 1000);
        }

        function stopQuestionTimer() {
            if (questionTimerInterval) {
                clearInterval(questionTimerInterval);
            }
            return questionStartTime ? Math.floor((Date.now() - questionStartTime) / 1000) : 0;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–º–µ—Ç–æ–∫
        async function loadNotes(questionId) {
            try {
                const response = await fetch(`/api/notes/${questionId}`);
                const note = await response.json();
                
                const notesDisplay = document.getElementById('userNotesDisplay');
                if (note.note_text) {
                    notesDisplay.textContent = note.note_text;
                    document.getElementById('notesCard').classList.remove('hidden');
                } else {
                    document.getElementById('notesCard').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
        document.getElementById('showAnswerBtnReview').addEventListener('click', () => {
            stopQuestionTimer();
            
            document.getElementById('answerText').innerHTML = parseMarkdownToHtml(currentQuestion.answer_text);
            document.getElementById('answerText').querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            answerSection.classList.remove('hidden');
            setupConfidenceButtons();
        });

        // Confidence buttons
        function setupConfidenceButtons() {
            const buttons = document.querySelectorAll('.confidence-card');
            buttons.forEach(btn => {
                btn.onclick = async () => {
                    const level = parseInt(btn.dataset.level);
                    const timeSpent = stopQuestionTimer();
                    
                    // –í–∏–∑—É–∞–ª—å–Ω—ã–π feedback
                    btn.style.background = 'var(--accent-color)';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'var(--accent-color)';
                    
                    try {
                        await fetch('/api/review/update', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                question_id: currentQuestion.id,
                                confidence_level: level,
                                time_spent: timeSpent
                            })
                        });
                        
                        reviewedToday++;
                        
                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
                        setTimeout(() => {
                            currentIndex++;
                            loadCurrentQuestion();
                        }, 500);
                        
                    } catch (error) {
                        showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                    }
                };
            });
        }

        // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
        document.getElementById('skipBtn').addEventListener('click', () => {
            if (confirm('–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å?')) {
                stopQuestionTimer();
                currentIndex++;
                loadCurrentQuestion();
            }
        });

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        function showCompletion() {
            reviewArea.classList.add('hidden');
            completionSection.classList.remove('hidden');
            document.getElementById('completedCount').textContent = reviewedToday;
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ markdown
        function parseMarkdownToHtml(text) {
            let html = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code class="language-${lang || 'text'}">${escapeHtml(code.trim())}</code></pre>`;
            });
            
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            html = '<p>' + html + '</p>';
            
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>

    <style>
        .confidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .confidence-card {
            padding: 1.5rem 1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .confidence-card:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .confidence-emoji {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .confidence-label {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .confidence-interval {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-block;
        }

        .badge-level {
            background: var(--accent-color);
            color: white;
        }

        .badge-level-1 { background: #10b981; }
        .badge-level-2 { background: #3b82f6; }
        .badge-level-3 { background: #f59e0b; }
        .badge-level-4 { background: #ef4444; }

        .badge-tag {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
    </style>
</body>
</html>

