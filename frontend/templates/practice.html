<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∞–∫—Ç–∏–∫–∞ - Interview Practice Platform</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">Interview Practice</a>
            <nav class="nav">
                <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="/practice" class="active">–ü—Ä–∞–∫—Ç–∏–∫–∞</a>
                <a href="/stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            </nav>
        </div>
    </header>

    <main class="container-narrow">
        <!-- –í—ã–±–æ—Ä —Ç–µ–º—ã -->
        <div id="topicSelection" class="mb-4">
            <h1>–í—ã–±–µ—Ä–∏ —Ç–µ–º—É –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏</h1>
            
            <div id="topicsList" class="grid grid-2">
                <!-- –¢–µ–º—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å –ø—Ä–∞–∫—Ç–∏–∫–∏ -->
        <div id="practiceArea" class="hidden">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏ -->
            <div class="flex-between mb-4" style="flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h2 id="topicName"></h2>
                    <p class="text-secondary" style="margin-top: 0.25rem;">
                        –í–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ: <span id="questionsCount" style="font-weight: 600; color: var(--accent-color);">0</span>
                    </p>
                </div>
                <button id="endSessionBtn" class="btn btn-secondary">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
            </div>

            <!-- –í–æ–ø—Ä–æ—Å -->
            <div id="questionContainer" class="question-container">
                <div class="question-header">
                    <h3 id="questionTitle"></h3>
                    <span id="difficultyBadge" class="difficulty-badge"></span>
                </div>
                
                <div id="questionText" style="line-height: 1.8;"></div>
            </div>

            <!-- –û–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ -->
            <div class="mb-4">
                <label for="userAnswer" style="display: block; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">
                    –¢–≤–æ–π –æ—Ç–≤–µ—Ç:
                </label>
                <textarea id="userAnswer" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ–π –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å... –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –±–ª–æ–∫ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç."></textarea>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="flex gap-2 mb-4" style="flex-wrap: wrap;">
                <button id="showAnswerBtn" class="btn btn-primary">‚úì –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</button>
                <button id="nextQuestionBtn" class="btn btn-secondary">‚Üí –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
            </div>

            <!-- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
            <div id="answerSection" class="answer-section hidden">
                <div class="answer-header">‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</div>
                <div id="answerText"></div>
            </div>
        </div>

        <!-- Summary —Å–µ—Å—Å–∏–∏ -->
        <div id="summarySection" class="hidden">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1 style="font-size: 2.25rem;">üéâ –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h1>
                <p class="text-secondary" style="font-size: 1.125rem; margin-top: 0.5rem;">
                    –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í–æ—Ç —Ç–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
                </p>
            </div>
            
            <div class="card mb-4">
                <h3 class="card-title mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏:</h3>
                <div id="summaryContent" style="font-size: 1rem;"></div>
            </div>

            <div style="margin-bottom: 1rem;">
                <h3 style="margin-bottom: 0.75rem;">–°–≤–æ–¥–∫–∞ –ø–æ —Ç–µ–º–µ:</h3>
            </div>
            <div class="summary-box" id="summaryText"></div>

            <div class="flex gap-2" style="flex-wrap: wrap; margin-top: 2rem;">
                <button id="copySummaryBtn" class="btn btn-primary">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–¥–∫—É</button>
                <a href="/practice" class="btn btn-secondary">üîÑ –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é</a>
            </div>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div id="loadingSpinner" class="hidden">
            <div class="spinner"></div>
        </div>
    </main>

    <script src="/static/app.js"></script>
    <script>
        let currentSession = null;
        let currentTopic = null;
        let currentQuestion = null;
        let questionsAnswered = 0;

        // –ü–æ–ª—É—á–∞–µ–º topic –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const urlParams = new URLSearchParams(window.location.search);
        const topicIdFromUrl = urlParams.get('topic');

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const topicSelection = document.getElementById('topicSelection');
        const practiceArea = document.getElementById('practiceArea');
        const summarySection = document.getElementById('summarySection');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        const topicsList = document.getElementById('topicsList');
        const topicName = document.getElementById('topicName');
        const questionsCount = document.getElementById('questionsCount');
        const questionTitle = document.getElementById('questionTitle');
        const difficultyBadge = document.getElementById('difficultyBadge');
        const questionText = document.getElementById('questionText');
        const userAnswer = document.getElementById('userAnswer');
        const answerSection = document.getElementById('answerSection');
        const answerText = document.getElementById('answerText');
        
        const showAnswerBtn = document.getElementById('showAnswerBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const endSessionBtn = document.getElementById('endSessionBtn');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            if (topicIdFromUrl) {
                await startPractice(parseInt(topicIdFromUrl));
            } else {
                await loadTopics();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–µ–º
        async function loadTopics() {
            try {
                const topics = await API.getTopics();
                
                if (topics.length === 0) {
                    topicsList.innerHTML = '<div class="card text-center"><p class="text-secondary">–¢–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.</p></div>';
                    return;
                }

                topicsList.innerHTML = topics.map(topic => `
                    <div class="card">
                        <h3 class="card-title">${topic.name}</h3>
                        <p class="text-secondary mb-2">–í–æ–ø—Ä–æ—Å–æ–≤: ${topic.question_count}</p>
                        <button onclick="startPractice(${topic.id})" class="btn btn-primary">–ù–∞—á–∞—Ç—å</button>
                    </div>
                `).join('');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º', 'error');
            }
        }

        // –ù–∞—á–∞–ª–æ –ø—Ä–∞–∫—Ç–∏–∫–∏
        async function startPractice(topicId) {
            try {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
                const session = await API.startSession();
                currentSession = session.session_id;
                currentTopic = topicId;
                questionsAnswered = 0;

                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–º–µ
                const topics = await API.getTopics();
                const topic = topics.find(t => t.id === topicId);
                topicName.textContent = topic.name;

                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                topicSelection.classList.add('hidden');
                practiceArea.classList.remove('hidden');

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
                await loadNextQuestion();

            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏–∏', 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
        async function loadNextQuestion() {
            try {
                loadingSpinner.classList.remove('hidden');
                answerSection.classList.add('hidden');
                userAnswer.value = '';

                const question = await API.getQuestion(currentTopic, null, currentSession);
                currentQuestion = question;

                questionTitle.textContent = question.title;
                difficultyBadge.textContent = question.difficulty;
                difficultyBadge.className = `difficulty-badge ${Utils.getDifficultyClass(question.difficulty)}`;
                
                // –ü–∞—Ä—Å–∏–º markdown –≤ questionText
                questionText.innerHTML = parseMarkdownToHtml(question.question_text);
                
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–¥–∞
                questionText.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });

                loadingSpinner.classList.add('hidden');

            } catch (error) {
                loadingSpinner.classList.add('hidden');
                
                if (error.message.includes('–≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ–π–¥–µ–Ω—ã')) {
                    showNotification('–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ç–µ–º–µ –ø—Ä–æ–π–¥–µ–Ω—ã!', 'success');
                    await endSession();
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–∞', 'error');
                }
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
        showAnswerBtn.addEventListener('click', async () => {
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (userAnswer.value.trim()) {
                    await API.submitAnswer(currentQuestion.id, userAnswer.value, currentSession);
                    questionsAnswered++;
                    questionsCount.textContent = questionsAnswered;
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                const questionWithAnswer = await API.getQuestionWithAnswer(currentQuestion.id);
                
                answerText.innerHTML = parseMarkdownToHtml(questionWithAnswer.answer_text);
                
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–¥–∞ –≤ –æ—Ç–≤–µ—Ç–µ
                answerText.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                answerSection.classList.remove('hidden');

            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–≤–µ—Ç–∞', 'error');
            }
        });

        // –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        nextQuestionBtn.addEventListener('click', async () => {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏
            if (!answerSection.classList.contains('hidden') && userAnswer.value.trim()) {
                // –û—Ç–≤–µ—Ç —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
            } else if (userAnswer.value.trim()) {
                await API.submitAnswer(currentQuestion.id, userAnswer.value, currentSession);
                questionsAnswered++;
                questionsCount.textContent = questionsAnswered;
            }

            await loadNextQuestion();
        });

        // –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é
        endSessionBtn.addEventListener('click', async () => {
            if (confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é? –¢—ã —É–≤–∏–¥–∏—à—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.')) {
                await endSession();
            }
        });

        async function endSession() {
            try {
                loadingSpinner.classList.remove('hidden');
                
                const result = await API.endSession(currentSession);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º summary
                practiceArea.classList.add('hidden');
                loadingSpinner.classList.add('hidden');
                summarySection.classList.remove('hidden');

                document.getElementById('summaryContent').innerHTML = `
                    <p><strong>–í–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ:</strong> ${result.questions_count}</p>
                    <p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${Utils.formatDuration(result.duration_minutes)}</p>
                `;

                document.getElementById('summaryText').textContent = result.summary;

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                document.getElementById('copySummaryBtn').addEventListener('click', async () => {
                    const success = await copyToClipboard(result.summary);
                    if (success) {
                        showNotification('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                    } else {
                        showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                    }
                });

            } catch (error) {
                loadingSpinner.classList.add('hidden');
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏', 'error');
            }
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ markdown –≤ HTML
        function parseMarkdownToHtml(text) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ code blocks
            let html = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code class="language-${lang || 'text'}">${escapeHtml(code.trim())}</code></pre>`;
            });
            
            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            html = '<p>' + html + '</p>';
            
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>

