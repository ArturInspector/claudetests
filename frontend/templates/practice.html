<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∞–∫—Ç–∏–∫–∞ - Deep Learning Platform</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">Deep Learning Platform</a>
            <nav class="nav">
                <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="/practice" class="active">–í–æ–ø—Ä–æ—Å—ã</a>
                <a href="/tasks">–ó–∞–¥–∞—á–∏</a>
                <a href="/stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            </nav>
        </div>
    </header>

    <main style="max-width: 1400px; margin: 0 auto; padding: 2rem;">
        <!-- –í—ã–±–æ—Ä —Ç–µ–º—ã -->
        <div id="topicSelection" class="mb-4">
            <h1 style="font-size: 2rem; margin-bottom: 1rem;">–í—ã–±–µ—Ä–∏ —Ç–µ–º—É –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏</h1>
            
            <div id="topicsList" class="grid grid-2">
                <!-- –¢–µ–º—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å –ø—Ä–∞–∫—Ç–∏–∫–∏ -->
        <div id="practiceArea" class="hidden" style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem;">
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div>
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏ + –¢–∞–π–º–µ—Ä -->
                <div class="flex-between mb-4">
                    <div>
                        <h2 id="topicName" style="margin-bottom: 0.25rem;"></h2>
                        <p class="text-secondary">
                            –í–æ–ø—Ä–æ—Å–æ–≤: <span id="questionsCount">0</span> | 
                            –í—Ä–µ–º—è: <span id="timer">00:00</span>
                        </p>
                    </div>
                    <button id="endSessionBtn" class="btn btn-secondary">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
                </div>

                <!-- –í–æ–ø—Ä–æ—Å -->
                <div id="questionContainer" class="question-container">
                    <div class="question-header">
                        <div>
                            <h3 id="questionTitle" style="margin-bottom: 0.5rem;"></h3>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <span id="levelBadge" class="badge badge-level"></span>
                                <span id="difficultyBadge" class="difficulty-badge"></span>
                                <div id="tagsBadges"></div>
                            </div>
                        </div>
                        <div id="questionTimer" style="font-size: 1.5rem; font-weight: 600; color: var(--accent-color);">00:00</div>
                    </div>
                    
                    <div id="questionText" style="line-height: 1.8; margin-top: 1.5rem;"></div>
                </div>

                <!-- –û–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ -->
                <div class="mb-4">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.75rem;">
                        –¢–≤–æ–π –æ—Ç–≤–µ—Ç:
                    </label>
                    <textarea id="userAnswer" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ–π –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å..."></textarea>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="flex gap-2 mb-4">
                    <button id="showAnswerBtn" class="btn btn-primary">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
                    <button id="nextQuestionBtn" class="btn btn-secondary">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
                </div>

                <!-- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç -->
                <div id="answerSection" class="answer-section hidden">
                    <div class="answer-header">‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</div>
                    <div id="answerText"></div>
                    
                    <!-- Confidence Rating -->
                    <div class="mt-4" style="padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                        <label style="display: block; margin-bottom: 0.75rem; font-weight: 600;">
                            –ù–∞—Å–∫–æ–ª—å–∫–æ —É–≤–µ—Ä–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ?
                        </label>
                        <div id="confidenceRating" style="display: flex; gap: 0.5rem;">
                            <button class="confidence-btn" data-level="1">‚òÖ</button>
                            <button class="confidence-btn" data-level="2">‚òÖ‚òÖ</button>
                            <button class="confidence-btn" data-level="3">‚òÖ‚òÖ‚òÖ</button>
                            <button class="confidence-btn" data-level="4">‚òÖ‚òÖ‚òÖ‚òÖ</button>
                            <button class="confidence-btn" data-level="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</button>
                        </div>
                        <p class="text-secondary" style="font-size: 0.875rem; margin-top: 0.5rem;">
                            1 - –Ω–µ –ø–æ–Ω—è–ª, 5 - –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–Ω—è–ª
                        </p>
                    </div>
                </div>

                <!-- –†–µ—Å—É—Ä—Å—ã -->
                <div id="resourcesSection" class="card mt-4 hidden">
                    <h3 style="margin-bottom: 1rem;">üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
                    <div id="resourcesList"></div>
                </div>

                <!-- –ó–∞–º–µ—Ç–∫–∏ -->
                <div class="card mt-4">
                    <h3 style="margin-bottom: 0.75rem;">üìù –¢–≤–æ–∏ –∑–∞–º–µ—Ç–∫–∏</h3>
                    <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: 0.75rem;">
                        –ó–∞–ø–∏—Å—ã–≤–∞–π –≤–∞–∂–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –∏ –º—ã—Å–ª–∏ (–∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
                    </p>
                    <textarea id="userNotes" 
                              placeholder="–¢–≤–æ–∏ –∑–∞–º–µ—Ç–∫–∏ –∫ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É..."
                              style="min-height: 100px;"
                              ></textarea>
                    <div id="notesSaveStatus" class="text-secondary" style="font-size: 0.75rem; margin-top: 0.5rem;"></div>
                </div>
            </div>

            <!-- Sidebar -->
            <div>
                <!-- Progressive Disclosure -->
                <div id="progressiveDisclosure" class="card mb-4 hidden">
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">üéØ –£—Ä–æ–≤–Ω–∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è</h3>
                    <div id="levelsList"></div>
                </div>

                <!-- Related Concepts -->
                <div id="relatedConcepts" class="card hidden">
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ–º—ã</h3>
                    <div id="relatedList"></div>
                </div>
            </div>
        </div>

        <!-- Summary —Å–µ—Å—Å–∏–∏ -->
        <div id="summarySection" class="hidden" style="max-width: 800px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1 style="font-size: 2.25rem;">üéâ –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h1>
                <p class="text-secondary" style="font-size: 1.125rem; margin-top: 0.5rem;">
                    –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í–æ—Ç —Ç–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
                </p>
            </div>
            
            <div class="card mb-4">
                <h3 class="card-title mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h3>
                <div id="summaryContent"></div>
            </div>

            <div class="summary-box" id="summaryText"></div>

            <div class="flex gap-2" style="margin-top: 2rem;">
                <button id="copySummaryBtn" class="btn btn-primary">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <a href="/practice" class="btn btn-secondary">–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é</a>
            </div>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div id="loadingSpinner" class="hidden">
            <div class="spinner"></div>
        </div>
    </main>

    <script src="/static/app.js"></script>
    <script>
        let currentSession = null;
        let currentTopic = null;
        let currentQuestion = null;
        let questionsAnswered = 0;
        let questionStartTime = null;
        let sessionStartTime = null;
        let timerInterval = null;
        let questionTimerInterval = null;
        let noteSaveTimeout = null;

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const topicSelection = document.getElementById('topicSelection');
        const practiceArea = document.getElementById('practiceArea');
        const summarySection = document.getElementById('summarySection');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        const topicName = document.getElementById('topicName');
        const questionsCount = document.getElementById('questionsCount');
        const questionTitle = document.getElementById('questionTitle');
        const levelBadge = document.getElementById('levelBadge');
        const difficultyBadge = document.getElementById('difficultyBadge');
        const tagsBadges = document.getElementById('tagsBadges');
        const questionText = document.getElementById('questionText');
        const userAnswer = document.getElementById('userAnswer');
        const answerSection = document.getElementById('answerSection');
        const answerText = document.getElementById('answerText');
        const userNotes = document.getElementById('userNotes');
        
        const showAnswerBtn = document.getElementById('showAnswerBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const endSessionBtn = document.getElementById('endSessionBtn');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const topicIdFromUrl = urlParams.get('topic');

            if (topicIdFromUrl) {
                await startPractice(parseInt(topicIdFromUrl));
            } else {
                await loadTopics();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–µ–º
        async function loadTopics() {
            try {
                const topics = await API.getTopics();
                
                if (topics.length === 0) {
                    document.getElementById('topicsList').innerHTML = '<div class="card text-center"><p class="text-secondary">–¢–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
                    return;
                }

                document.getElementById('topicsList').innerHTML = topics.map(topic => `
                    <div class="card">
                        <h3 class="card-title">${topic.name}</h3>
                        <p class="text-secondary mb-2">–í–æ–ø—Ä–æ—Å–æ–≤: ${topic.question_count}</p>
                        <button onclick="startPractice(${topic.id})" class="btn btn-primary">–ù–∞—á–∞—Ç—å</button>
                    </div>
                `).join('');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º', 'error');
            }
        }

        // –ù–∞—á–∞–ª–æ –ø—Ä–∞–∫—Ç–∏–∫–∏
        async function startPractice(topicId) {
            try {
                const session = await API.startSession();
                currentSession = session.session_id;
                currentTopic = topicId;
                questionsAnswered = 0;
                sessionStartTime = Date.now();

                const topics = await API.getTopics();
                const topic = topics.find(t => t.id === topicId);
                topicName.textContent = topic.name;

                topicSelection.classList.add('hidden');
                practiceArea.classList.remove('hidden');
                practiceArea.style.display = 'grid';

                startSessionTimer();
                await loadNextQuestion();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏–∏', 'error');
            }
        }

        // –¢–∞–π–º–µ—Ä—ã
        function startSessionTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                document.getElementById('timer').textContent = formatTime(elapsed);
            }, 1000);
        }

        function startQuestionTimer() {
            questionStartTime = Date.now();
            questionTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - questionStartTime) / 1000);
                document.getElementById('questionTimer').textContent = formatTime(elapsed);
            }, 1000);
        }

        function stopQuestionTimer() {
            if (questionTimerInterval) {
                clearInterval(questionTimerInterval);
            }
            return questionStartTime ? Math.floor((Date.now() - questionStartTime) / 1000) : 0;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
        async function loadNextQuestion() {
            try {
                loadingSpinner.classList.remove('hidden');
                answerSection.classList.add('hidden');
                userAnswer.value = '';
                userNotes.value = '';

                const question = await API.getQuestion(currentTopic, null, currentSession);
                currentQuestion = question;

                questionTitle.textContent = question.title;
                
                // Level badge
                levelBadge.textContent = `Level ${question.level || 1}`;
                levelBadge.className = `badge badge-level badge-level-${question.level || 1}`;
                
                // Difficulty
                difficultyBadge.textContent = question.difficulty;
                difficultyBadge.className = `difficulty-badge ${Utils.getDifficultyClass(question.difficulty)}`;
                
                // Tags
                if (question.tags && question.tags.length > 0) {
                    tagsBadges.innerHTML = question.tags.map(tag => 
                        `<span class="badge badge-tag">${tag}</span>`
                    ).join('');
                } else {
                    tagsBadges.innerHTML = '';
                }
                
                questionText.innerHTML = parseMarkdownToHtml(question.question_text);
                questionText.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã
                await loadResources(question.id);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–º–µ—Ç–∫–∏
                await loadNotes(question.id);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º related concepts
                await loadRelatedConcepts(question.id);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º progressive disclosure
                await loadProgressiveDisclosure(question.id);

                loadingSpinner.classList.add('hidden');
                startQuestionTimer();

            } catch (error) {
                loadingSpinner.classList.add('hidden');
                
                if (error.message.includes('–≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ–π–¥–µ–Ω—ã')) {
                    showNotification('–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ–π–¥–µ–Ω—ã!', 'success');
                    await endSession();
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–∞', 'error');
                }
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
        async function loadResources(questionId) {
            try {
                const response = await fetch(`/api/resources/${questionId}`);
                const resources = await response.json();
                
                if (resources.length > 0) {
                    const resourcesSection = document.getElementById('resourcesSection');
                    const resourcesList = document.getElementById('resourcesList');
                    
                    resourcesList.innerHTML = resources.map(r => `
                        <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <span class="badge badge-resource">${getResourceIcon(r.type)} ${r.type}</span>
                                <strong>${r.title}</strong>
                            </div>
                            <a href="${r.url}" target="_blank" style="color: var(--accent-color); font-size: 0.875rem; word-break: break-all;">
                                ${r.url}
                            </a>
                        </div>
                    `).join('');
                    
                    resourcesSection.classList.remove('hidden');
                } else {
                    document.getElementById('resourcesSection').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading resources:', error);
            }
        }

        function getResourceIcon(type) {
            const icons = {
                'video': 'üé•',
                'article': 'üìñ',
                'code': 'üíª',
                'tool': 'üîß',
                'docs': 'üìÑ'
            };
            return icons[type] || 'üìé';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–º–µ—Ç–æ–∫
        async function loadNotes(questionId) {
            try {
                const response = await fetch(`/api/notes/${questionId}`);
                const note = await response.json();
                userNotes.value = note.note_text || '';
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫
        userNotes.addEventListener('input', () => {
            clearTimeout(noteSaveTimeout);
            document.getElementById('notesSaveStatus').textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            noteSaveTimeout = setTimeout(async () => {
                try {
                    await fetch('/api/notes', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            question_id: currentQuestion.id,
                            note_text: userNotes.value
                        })
                    });
                    document.getElementById('notesSaveStatus').textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                    setTimeout(() => {
                        document.getElementById('notesSaveStatus').textContent = '';
                    }, 2000);
                } catch (error) {
                    document.getElementById('notesSaveStatus').textContent = '‚úó –û—à–∏–±–∫–∞';
                }
            }, 1000);
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ related concepts
        async function loadRelatedConcepts(questionId) {
            try {
                const response = await fetch(`/api/questions/${questionId}/related`);
                const related = await response.json();
                
                if (Object.keys(related).length > 0) {
                    const relatedSection = document.getElementById('relatedConcepts');
                    const relatedList = document.getElementById('relatedList');
                    
                    let html = '';
                    for (const [type, questions] of Object.entries(related)) {
                        html += `<div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; font-size: 0.875rem; margin-bottom: 0.5rem; text-transform: capitalize;">${type}:</div>`;
                        questions.forEach(q => {
                            html += `<div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 0.375rem; margin-bottom: 0.5rem; font-size: 0.875rem;">
                                <div>${q.title}</div>
                                <div style="color: var(--text-secondary); font-size: 0.75rem;">Level ${q.level} ‚Ä¢ ${q.difficulty}</div>
                            </div>`;
                        });
                        html += '</div>';
                    }
                    
                    relatedList.innerHTML = html;
                    relatedSection.classList.remove('hidden');
                } else {
                    document.getElementById('relatedConcepts').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading related:', error);
            }
        }

        // Progressive Disclosure
        async function loadProgressiveDisclosure(questionId) {
            try {
                const response = await fetch(`/api/questions/${questionId}/children`);
                const children = await response.json();
                
                if (children.length > 0) {
                    const section = document.getElementById('progressiveDisclosure');
                    const list = document.getElementById('levelsList');
                    
                    list.innerHTML = children.map((q, idx) => `
                        <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.375rem; margin-bottom: 0.5rem; cursor: pointer;"
                             onclick="loadSpecificQuestion(${q.id})">
                            <div style="font-weight: 600; font-size: 0.875rem;">Level ${q.level}: ${q.title}</div>
                            <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">${q.difficulty}</div>
                        </div>
                    `).join('');
                    
                    section.classList.remove('hidden');
                } else {
                    document.getElementById('progressiveDisclosure').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading progressive disclosure:', error);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
        showAnswerBtn.addEventListener('click', async () => {
            const timeSpent = stopQuestionTimer();
            
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç —Å showed_answer = true
                if (userAnswer.value.trim()) {
                    await API.submitAnswer(
                        currentQuestion.id,
                        userAnswer.value,
                        currentSession,
                        timeSpent,
                        true,  // showed_answer
                        null   // confidence –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞
                    );
                    questionsAnswered++;
                    questionsCount.textContent = questionsAnswered;
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                const questionWithAnswer = await fetch(`/api/question/${currentQuestion.id}/answer`).then(r => r.json());
                
                answerText.innerHTML = parseMarkdownToHtml(questionWithAnswer.answer_text);
                answerText.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                answerSection.classList.remove('hidden');
                
                // Setup confidence rating
                setupConfidenceRating(timeSpent);

            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–≤–µ—Ç–∞', 'error');
            }
        });

        // Confidence Rating
        function setupConfidenceRating(timeSpent) {
            const buttons = document.querySelectorAll('.confidence-btn');
            buttons.forEach(btn => {
                btn.onclick = async () => {
                    const level = parseInt(btn.dataset.level);
                    
                    // –í–∏–∑—É–∞–ª—å–Ω—ã–π feedback
                    buttons.forEach(b => b.style.background = 'var(--bg-secondary)');
                    btn.style.background = 'var(--accent-color)';
                    btn.style.color = 'white';
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å confidence
                    try {
                        await API.submitAnswer(
                            currentQuestion.id,
                            userAnswer.value,
                            currentSession,
                            timeSpent,
                            true,
                            level
                        );
                        showNotification(`Confidence ${level}/5 —Å–æ—Ö—Ä–∞–Ω–µ–Ω`, 'success');
                    } catch (error) {
                        showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                    }
                };
            });
        }

        // –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        nextQuestionBtn.addEventListener('click', async () => {
            const timeSpent = stopQuestionTimer();
            
            if (!answerSection.classList.contains('hidden') && userAnswer.value.trim()) {
                // –£–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –æ—Ç–≤–µ—Ç–∞
            } else if (userAnswer.value.trim()) {
                await API.submitAnswer(currentQuestion.id, userAnswer.value, currentSession, timeSpent, false, null);
                questionsAnswered++;
                questionsCount.textContent = questionsAnswered;
            }

            await loadNextQuestion();
        });

        // –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é
        endSessionBtn.addEventListener('click', async () => {
            if (confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é?')) {
                await endSession();
            }
        });

        async function endSession() {
            try {
                clearInterval(timerInterval);
                stopQuestionTimer();
                
                loadingSpinner.classList.remove('hidden');
                
                const result = await API.endSession(currentSession);
                
                practiceArea.style.display = 'none';
                loadingSpinner.classList.add('hidden');
                summarySection.classList.remove('hidden');

                document.getElementById('summaryContent').innerHTML = `
                    <p><strong>–í–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ:</strong> ${result.questions_count}</p>
                    <p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${Utils.formatDuration(result.duration_minutes)}</p>
                `;

                document.getElementById('summaryText').textContent = result.summary;

                document.getElementById('copySummaryBtn').addEventListener('click', async () => {
                    const success = await copyToClipboard(result.summary);
                    showNotification(success ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!' : '–û—à–∏–±–∫–∞', success ? 'success' : 'error');
                });

            } catch (error) {
                loadingSpinner.classList.add('hidden');
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏', 'error');
            }
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ markdown
        function parseMarkdownToHtml(text) {
            let html = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code class="language-${lang || 'text'}">${escapeHtml(code.trim())}</code></pre>`;
            });
            
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            html = '<p>' + html + '</p>';
            
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>

    <style>
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-block;
        }

        .badge-level {
            background: var(--accent-color);
            color: white;
        }

        .badge-level-1 { background: #10b981; color: white; }
        .badge-level-2 { background: #3b82f6; color: white; }
        .badge-level-3 { background: #f59e0b; color: white; }
        .badge-level-4 { background: #ef4444; color: white; }

        .badge-tag {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .badge-resource {
            background: #ede9fe;
            color: #6b21a8;
        }

        .confidence-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s;
        }

        .confidence-btn:hover {
            background: var(--bg-hover);
            transform: scale(1.05);
        }

        @media (max-width: 1024px) {
            #practiceArea {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</body>
</html>
