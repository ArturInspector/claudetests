<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - Deep Learning Platform</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">Deep Learning Platform</a>
            <nav class="nav">
                <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="/practice">–ü—Ä–∞–∫—Ç–∏–∫–∞</a>
                <a href="/review">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</a>
                <a href="/stats" class="active">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 3rem;">
                <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">üìä –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
                <p class="text-secondary" style="font-size: 1.125rem;">
                    –û—Ç—Å–ª–µ–∂–∏–≤–∞–π —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –Ω–∞—Ö–æ–¥–∏ —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞
                </p>
            </div>

            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="grid grid-2 mb-4" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="stat-card">
                    <div class="stat-value" id="totalQuestions">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="answeredQuestions">0</div>
                    <div class="stat-label">–û—Ç–≤–µ—á–µ–Ω–æ</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="progressPercent">0%</div>
                    <div class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="totalSessions">0</div>
                    <div class="stat-label">–°–µ—Å—Å–∏–π</div>
                </div>
            </div>

            <!-- Knowledge Map -->
            <div class="card mb-4">
                <h2 style="margin-bottom: 1.5rem;">üó∫Ô∏è Knowledge Map</h2>
                <p class="text-secondary" style="margin-bottom: 1.5rem;">
                    –¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É—Ä–æ–≤–Ω—è–º –ø–æ–Ω–∏–º–∞–Ω–∏—è
                </p>
                <div id="knowledgeMap"></div>
            </div>

            <!-- Retention (Spaced Repetition) -->
            <div class="card mb-4">
                <h2 style="margin-bottom: 1.5rem;">üîÑ Retention & Review</h2>
                <div class="grid grid-2" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-color); margin-bottom: 0.5rem;" id="dueTodayCount">0</div>
                        <div class="text-secondary">–í–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                    </div>
                    <div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: #3b82f6; margin-bottom: 0.5rem;" id="dueTomorrowCount">0</div>
                        <div class="text-secondary">–í–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∑–∞–≤—Ç—Ä–∞</div>
                    </div>
                    <div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: #10b981; margin-bottom: 0.5rem;" id="totalInReviewCount">0</div>
                        <div class="text-secondary">–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</div>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="/review" class="btn btn-primary">–ù–∞—á–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ ‚Üí</a>
                </div>
            </div>

            <!-- Weak Spots -->
            <div class="card mb-4" id="weakSpotsSection">
                <h2 style="margin-bottom: 1.5rem;">‚ö†Ô∏è –°–ª–∞–±—ã–µ –º–µ—Å—Ç–∞</h2>
                <p class="text-secondary" style="margin-bottom: 1.5rem;">
                    –¢–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –±–æ–ª—å—à–µ –≤–Ω–∏–º–∞–Ω–∏—è
                </p>
                <div id="weakSpotsList"></div>
            </div>

            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º -->
            <div class="mb-4">
                <h2 style="font-size: 1.75rem; margin-bottom: 1rem;">üìö –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º</h2>
                <div id="topicsProgress"></div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏ -->
            <div class="mb-4">
                <h2 style="font-size: 1.75rem; margin-bottom: 1rem;">üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏</h2>
                <div id="recentSessions"></div>
            </div>

            <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
            <div class="card mb-4">
                <h2 style="margin-bottom: 1rem;">üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)</h2>
                <div id="activityChart">
                    <div id="activityContent"></div>
                </div>
            </div>

            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
            <div id="loadingSpinner" class="hidden">
                <div class="spinner"></div>
            </div>
        </div>
    </main>

    <script src="/static/app.js"></script>
    <script>
        const loadingSpinner = document.getElementById('loadingSpinner');

        async function loadStats() {
            try {
                loadingSpinner.classList.remove('hidden');
                
                const stats = await API.getStats();
                const sessions = await API.getRecentSessions(10);
                const reviewStats = await fetch('/api/review/stats').then(r => r.json());

                // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                document.getElementById('totalQuestions').textContent = stats.total_questions;
                document.getElementById('answeredQuestions').textContent = stats.answered_questions;
                document.getElementById('progressPercent').textContent = stats.progress_percent + '%';
                document.getElementById('totalSessions').textContent = stats.total_sessions;

                // Review stats
                document.getElementById('dueTodayCount').textContent = reviewStats.due_today;
                document.getElementById('dueTomorrowCount').textContent = reviewStats.due_tomorrow;
                document.getElementById('totalInReviewCount').textContent = reviewStats.total_in_review;

                // Knowledge Map
                renderKnowledgeMap(stats.topics);

                // Weak Spots
                renderWeakSpots(stats.topics);

                // –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º
                if (stats.topics.length > 0) {
                    document.getElementById('topicsProgress').innerHTML = stats.topics.map(topic => `
                        <div class="card mb-2">
                            <div class="flex-between mb-1">
                                <h3 style="font-weight: 600;">${topic.name}</h3>
                                <span class="text-secondary">${topic.answered_questions} / ${topic.total_questions}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${topic.progress_percent}%"></div>
                            </div>
                            <p class="text-secondary" style="font-size: 0.875rem; margin-top: 0.5rem;">
                                ${topic.progress_percent}% –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                            </p>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('topicsProgress').innerHTML = '<div class="card text-center"><p class="text-secondary">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p></div>';
                }

                // –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏
                if (sessions.length > 0) {
                    document.getElementById('recentSessions').innerHTML = sessions.map(session => {
                        const startDate = new Date(session.started_at);
                        const formattedDate = startDate.toLocaleDateString('ru-RU', {
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        return `
                            <div class="card mb-2">
                                <div class="flex-between">
                                    <div>
                                        <p style="font-weight: 500;">${formattedDate}</p>
                                        <p class="text-secondary" style="font-size: 0.875rem;">
                                            ${session.questions_count} –≤–æ–ø—Ä–æ—Å–æ–≤
                                            ${session.duration_minutes ? ` ‚Ä¢ ${Utils.formatDuration(session.duration_minutes)}` : ''}
                                        </p>
                                    </div>
                                    ${session.ended_at ? '<span style="color: #10b981;">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>' : '<span style="color: #f59e0b;">‚è± –í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>'}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('recentSessions').innerHTML = '<div class="card text-center"><p class="text-secondary">–ü–æ–∫–∞ –Ω–µ—Ç —Å–µ—Å—Å–∏–π</p></div>';
                }

                // –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                if (stats.daily_activity.length > 0) {
                    renderActivityChart(stats.daily_activity);
                } else {
                    document.getElementById('activityContent').innerHTML = '<p class="text-center text-secondary">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</p>';
                }

                loadingSpinner.classList.add('hidden');

            } catch (error) {
                loadingSpinner.classList.add('hidden');
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
            }
        }

        // Knowledge Map –ø–æ —É—Ä–æ–≤–Ω—è–º
        function renderKnowledgeMap(topics) {
            const container = document.getElementById('knowledgeMap');
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –ø–æ —É—Ä–æ–≤–Ω—è–º (mock data - –Ω—É–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å API)
            const levels = [
                { level: 1, name: 'Surface (L1)', color: '#10b981', percent: 0 },
                { level: 2, name: 'Deeper (L2)', color: '#3b82f6', percent: 0 },
                { level: 3, name: 'Expert (L3)', color: '#f59e0b', percent: 0 },
                { level: 4, name: 'Master (L4)', color: '#ef4444', percent: 0 }
            ];
            
            // –î–ª—è demo - –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
            const avgProgress = topics.reduce((sum, t) => sum + t.progress_percent, 0) / (topics.length || 1);
            
            levels[0].percent = Math.min(100, avgProgress * 1.2);
            levels[1].percent = Math.max(0, avgProgress - 10);
            levels[2].percent = Math.max(0, avgProgress - 30);
            levels[3].percent = Math.max(0, avgProgress - 50);
            
            container.innerHTML = levels.map(level => `
                <div style="margin-bottom: 1.5rem;">
                    <div class="flex-between mb-1">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${level.color};"></div>
                            <span style="font-weight: 600;">${level.name}</span>
                        </div>
                        <span style="font-weight: 600; color: ${level.color};">${Math.round(level.percent)}%</span>
                    </div>
                    <div class="progress-bar" style="height: 8px;">
                        <div class="progress-fill" style="width: ${level.percent}%; background: ${level.color};"></div>
                    </div>
                </div>
            `).join('');
        }

        // Weak Spots
        function renderWeakSpots(topics) {
            const weakTopics = topics.filter(t => t.progress_percent < 50 && t.total_questions > 0);
            
            if (weakTopics.length === 0) {
                document.getElementById('weakSpotsSection').classList.add('hidden');
                return;
            }
            
            weakTopics.sort((a, b) => a.progress_percent - b.progress_percent);
            
            const weakSpotsList = document.getElementById('weakSpotsList');
            weakSpotsList.innerHTML = weakTopics.slice(0, 3).map(topic => {
                let recommendation = '';
                if (topic.progress_percent === 0) {
                    recommendation = '–ï—â–µ –Ω–µ –Ω–∞—á–∞–ª —ç—Ç—É —Ç–µ–º—É. –ù–∞—á–Ω–∏ —Å –±–∞–∑–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤!';
                } else if (topic.progress_percent < 25) {
                    recommendation = '–ú–∞–ª–æ –ø—Ä–∞–∫—Ç–∏–∫–∏. –£–¥–µ–ª—è–π 15-20 –º–∏–Ω—É—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ.';
                } else {
                    recommendation = '–ü–æ—á—Ç–∏ –ø–æ–ª–æ–≤–∏–Ω–∞! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.';
                }
                
                return `
                    <div style="padding: 1.5rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div class="flex-between mb-2">
                            <h3 style="font-weight: 600; color: #92400e;">${topic.name}</h3>
                            <span style="font-weight: 600; color: #f59e0b;">${topic.progress_percent}%</span>
                        </div>
                        <p style="color: #78350f; margin-bottom: 1rem;">${recommendation}</p>
                        <div class="flex gap-2">
                            <a href="/practice?topic=${topic.id}" class="btn btn-primary" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                –ù–∞—á–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É
                            </a>
                            <button onclick="showTopicTips('${topic.name}')" class="btn btn-outline" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                –°–æ–≤–µ—Ç—ã
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showTopicTips(topicName) {
            const tips = {
                'Solidity Advanced': '‚Ä¢ –ù–∞—á–Ω–∏ —Å —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (reentrancy, overflow)\n‚Ä¢ –ü—Ä–∞–∫—Ç–∏–∫—É–π CEI pattern\n‚Ä¢ –ò–∑—É—á–∞–π —Ä–µ–∞–ª—å–Ω—ã–µ exploits\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π Remix –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤',
                'Python Web3 Development': '‚Ä¢ –û—Å–≤–æ–π web3.py basics\n‚Ä¢ –ü—Ä–∞–∫—Ç–∏–∫—É–π —á—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤\n‚Ä¢ –ù–∞—É—á–∏—Å—å –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\n‚Ä¢ –†–∞–∑–±–µ—Ä–∏—Å—å —Å events –∏ filters',
                'default': '‚Ä¢ –£–¥–µ–ª—è–π 15-20 –º–∏–Ω—É—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ\n‚Ä¢ –ù–∞—á–Ω–∏ —Å –ª–µ–≥–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (Easy)\n‚Ä¢ –ó–∞–ø–∏—Å—ã–≤–∞–π –≤–∞–∂–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –≤ –∑–∞–º–µ—Ç–∫–∏\n‚Ä¢ –ü–æ–≤—Ç–æ—Ä—è–π –º–∞—Ç–µ—Ä–∏–∞–ª —á–µ—Ä–µ–∑ spaced repetition'
            };
            
            alert(tips[topicName] || tips['default']);
        }

        // –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        function renderActivityChart(activityData) {
            if (activityData.length === 0) {
                document.getElementById('activityContent').innerHTML = '<p class="text-center text-secondary">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                return;
            }

            const maxCount = Math.max(...activityData.map(d => d.count), 1);

            const chartHtml = activityData.map(item => {
                const date = new Date(item.date);
                const dateStr = date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
                const barWidth = (item.count / maxCount) * 100;

                return `
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                        <div style="width: 80px; font-size: 0.875rem; color: var(--text-secondary);">
                            ${dateStr}
                        </div>
                        <div style="flex: 1; background: var(--bg-secondary); height: 24px; border-radius: 0.25rem; overflow: hidden;">
                            <div style="width: ${barWidth}%; height: 100%; background: var(--accent-color); transition: width 0.3s;"></div>
                        </div>
                        <div style="width: 40px; text-align: right; font-size: 0.875rem; font-weight: 500; margin-left: 0.5rem;">
                            ${item.count}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('activityContent').innerHTML = chartHtml;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadStats();
    </script>
</body>
</html>
